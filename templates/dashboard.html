{% extends "base.html" %}

{% block title %}My Dashboard - Learnex{% endblock %}

{% block content %}
<div class="container py-4">
    <style>
        /* Settings Section Styles */
        .settings-form {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .form-text {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 5px;
        }
    </style>
    <!-- Status Bar -->
    <div class="card border-0 shadow-lg mb-4" style="background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);">
        <div class="card-body text-white p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="h4 mb-0">üìä Aptitude Practice Progress</h2>
                <a href="{{ url_for('aptitude_quiz') }}" class="btn btn-light text-primary fw-bold">
                    Start Practice
                </a>
            </div>
            <div id="status-content">
                <div class="text-center py-4">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading statistics...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs nav-fill mb-4" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-semibold" id="chats-tab-btn" data-bs-toggle="tab"
                data-bs-target="#chats-tab" type="button" role="tab" aria-controls="chats-tab" aria-selected="true"
                onclick="loadTab('chats')">
                üí¨ Past Chats
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-semibold" id="quizzes-tab-btn" data-bs-toggle="tab" data-bs-target="#quizzes-tab"
                type="button" role="tab" aria-controls="quizzes-tab" aria-selected="false" onclick="loadTab('quizzes')">
                üé• Past Quizzes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-semibold" id="custom-tab-btn" data-bs-toggle="tab" data-bs-target="#custom-tab"
                type="button" role="tab" aria-controls="custom-tab" aria-selected="false" onclick="loadTab('custom')">
                üß© My Custom Quizzes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-semibold" id="settings-tab-btn" data-bs-toggle="tab"
                data-bs-target="#settings-tab" type="button" role="tab" aria-controls="settings-tab"
                aria-selected="false">
                ‚öôÔ∏è Settings
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="dashboardTabsContent">

        <!-- Chats Tab -->
        <div class="tab-pane fade show active" id="chats-tab" role="tabpanel" aria-labelledby="chats-tab-btn">
            <div class="card">
                <div class="card-header">
                    <h3 class="h5 mb-0 text-white">Chatbot Conversations</h3>
                </div>
                <div class="card-body" id="chats-container">
                    <div class="text-center py-5 text-muted">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading your conversations...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quizzes Tab -->
        <div class="tab-pane fade" id="quizzes-tab" role="tabpanel" aria-labelledby="quizzes-tab-btn">
            <div class="card">
                <div class="card-header">
                    <h3 class="h5 mb-0 text-white">Generated Quizzes</h3>
                </div>
                <div class="card-body" id="quizzes-container">
                    <div class="text-center py-5 text-muted">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading your quizzes...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Quizzes Tab -->
        <div class="tab-pane fade" id="custom-tab" role="tabpanel" aria-labelledby="custom-tab-btn">
            <div class="card">
                <div class="card-header">
                    <h3 class="h5 mb-0 text-white">My Custom Quiz Codes</h3>
                </div>
                <div class="card-body" id="custom-quizzes-container">
                    <div class="text-center py-5 text-muted">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading your custom quizzes...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings-tab" role="tabpanel" aria-labelledby="settings-tab-btn">
            <!-- API Key Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="h5 mb-0 text-white">API Configuration</h3>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('update_api_key') }}" method="POST">
                        <div class="form-group">
                            <label for="api_key" class="form-label">Gemini API Key</label>
                            <input type="password" id="api_key" name="api_key" class="form-input"
                                placeholder="Enter your Gemini API Key"
                                value="{{ current_user.api_key if current_user.api_key else '' }}">
                            <p class="form-text">
                                Add your own API key to ensure uninterrupted service.
                                Your key is stored securely and used only for your requests.
                            </p>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Save API Key
                        </button>
                    </form>
                </div>
            </div>
            <div class="card border-danger bg-danger bg-opacity-10">
                <div class="card-body">
                    <h3 class="h5 text-danger mb-3">‚ö†Ô∏è Danger Zone</h3>
                    <p class="text-muted mb-3">
                        Deleting your account will permanently remove all your data including:
                    </p>
                    <ul class="text-muted mb-3">
                        <li>Your account information</li>
                        <li>All chat conversations</li>
                        <li>All quiz history and scores</li>
                        <li>All custom quizzes you created</li>
                        <li>All custom quiz attempts</li>
                    </ul>
                    <p class="text-danger fw-bold mb-3">
                        This action cannot be undone!
                    </p>
                    <button class="btn btn-danger" onclick="deleteAccount()">
                        Delete My Account
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    window.chatsLoaded = false;
    window.quizzesLoaded = false;
    window.customQuizzesLoaded = false;
    window.aptitudeLoaded = false;

    // Load initial data
    document.addEventListener('DOMContentLoaded', () => {
        loadChats();
        loadStatusBar();
    });

    function loadTab(tabName) {
        if (tabName === 'chats' && !window.chatsLoaded) {
            loadChats();
        } else if (tabName === 'quizzes' && !window.quizzesLoaded) {
            loadQuizzes();
        } else if (tabName === 'custom' && !window.customQuizzesLoaded) {
            loadMyCustomQuizzes();
        }
    }

    async function loadChats() {
        const container = document.getElementById('chats-container');
        try {
            const resp = await fetch('/api/user-chats');
            if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
            const data = await resp.json();

            if (data.error) {
                container.innerHTML = `<div class="text-center text-danger p-4">Error: ${escapeHtml(data.error)}</div>`;
                return;
            }

            if (data.conversations && data.conversations.length > 0) {
                container.innerHTML = data.conversations.map(conv => {
                    const date = new Date(conv.timestamp).toLocaleString();
                    const fullUserMsg = (conv.user_message || '').trim();
                    const title = fullUserMsg.length > 80 ? fullUserMsg.slice(0, 80) + '...' : (fullUserMsg || '(no message)');
                    const botResponse = conv.bot_response || '';
                    const chatId = conv._id || (conv.timestamp || '').replace(/[^0-9]/g, '');

                    return `
                        <div class="card mb-3 border-start border-4 border-success bg-light bg-opacity-10">
                            <div class="card-body p-3 cursor-pointer" onclick="toggleChatDetails('${chatId}')" style="cursor: pointer;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">${date}</small>
                                    <div>
                                        <button class="btn btn-outline-danger btn-sm py-0 px-2" onclick="deleteChat(event, '${chatId}')">Delete</button>
                                        <span class="ms-2 text-muted" id="chevron-${chatId}">‚ñº</span>
                                    </div>
                                </div>
                                <div class="fw-semibold text-body">You: ${escapeHtml(title)}</div>
                                
                                <div class="mt-3 pt-3 border-top d-none" id="chat-details-${chatId}">
                                    <div class="mb-2 fw-bold text-primary">You: ${escapeHtml(fullUserMsg)}</div>
                                    <div class="ps-3 border-start border-2">Bot: ${botResponse}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <h4 class="text-muted">No conversations yet</h4>
                        <p class="text-muted">Start chatting with the bot to see your history here!</p>
                    </div>`;
            }
            window.chatsLoaded = true;
        } catch (error) {
            console.error('Error loading chats:', error);
            container.innerHTML = `<div class="text-center text-danger p-4">Error loading conversations: ${escapeHtml(error.message)}</div>`;
        }
    }

    async function loadQuizzes() {
        const container = document.getElementById('quizzes-container');
        try {
            const [respStandard, respCustom] = await Promise.all([
                fetch('/api/user-quizzes'),
                fetch('/api/user-custom-attempts')
            ]);

            const dataStandard = await respStandard.json();
            const dataCustom = await respCustom.json();

            if (!respStandard.ok || dataStandard.error) {
                container.innerHTML = `<div class="text-center text-danger p-4">Error: ${escapeHtml(dataStandard.error || `HTTP ${respStandard.status}`)}</div>`;
                return;
            }

            let htmlParts = [];

            if (dataStandard.quizzes && dataStandard.quizzes.length > 0) {
                const standardHtml = dataStandard.quizzes.map(quiz => {
                    const date = new Date(quiz.generated_at).toLocaleString();
                    const difficultyColors = { 'easy': 'success', 'medium': 'warning', 'hard': 'danger' };
                    const difficultyBadge = difficultyColors[quiz.difficulty] || 'primary';

                    let scoreHtml = quiz.score !== null && quiz.score !== undefined
                        ? `<span class="badge bg-success">Score: ${quiz.score}/${quiz.total_questions} (${quiz.percentage}%)</span>`
                        : `<span class="badge bg-warning text-dark">Not completed</span>`;

                    return `
                        <div class="card mb-3 border-start border-4 border-warning bg-light bg-opacity-10">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <small class="text-muted">Generated: ${date}</small>
                                    <span class="badge bg-${difficultyBadge}">${(quiz.difficulty || 'medium').toUpperCase()}</span>
                                </div>
                                <div class="mb-2">
                                    <a href="${quiz.video_url}" target="_blank" class="text-decoration-none fw-bold text-primary text-truncate d-block" style="max-width: 100%;">${quiz.video_url}</a>
                                </div>
                                <div class="d-flex gap-2">
                                    <span class="badge bg-info text-dark">${quiz.num_questions} Questions</span>
                                    ${scoreHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                htmlParts.push(standardHtml);
            } else {
                htmlParts.push(`<div class="text-center py-4"><p class="text-muted">No video quizzes generated yet.</p></div>`);
            }

            if (respCustom.ok && !dataCustom.error && dataCustom.attempts && dataCustom.attempts.length > 0) {
                const customHtmlHeader = '<h4 class="mt-4 mb-3 text-white">Custom Exam Attempts</h4>';
                const attemptsHtml = dataCustom.attempts.map(att => {
                    const date = att.submitted_at ? new Date(att.submitted_at).toLocaleString() : '';
                    return `
                        <div class="card mb-3 border-start border-4 border-info bg-light bg-opacity-10">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <small class="text-muted">Submitted: ${date}</small>
                                    <span class="badge bg-info text-dark">Custom Exam</span>
                                </div>
                                <div class="mb-2">
                                    <span class="fw-bold text-white">Code: ${escapeHtml(att.quiz_code || '')}</span>
                                    ${att.title ? `<div class="small text-muted">${escapeHtml(att.title)}</div>` : ''}
                                </div>
                                <div>
                                    <span class="badge bg-success">Score: ${att.score || 0}/${att.total_questions || 0} (${att.percentage || 0}%)</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                htmlParts.push(customHtmlHeader + attemptsHtml);
            }

            container.innerHTML = htmlParts.join('');
            window.quizzesLoaded = true;
        } catch (error) {
            container.innerHTML = `<div class="text-center text-danger p-4">Error loading quizzes: ${escapeHtml(error.message)}</div>`;
        }
    }

    async function loadMyCustomQuizzes() {
        const container = document.getElementById('custom-quizzes-container');
        try {
            const resp = await fetch('/api/my-custom-quizzes');
            if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
            const data = await resp.json();

            if (data.error) {
                container.innerHTML = `<div class="text-center text-danger p-4">Error: ${escapeHtml(data.error)}</div>`;
                return;
            }

            if (data.quizzes && data.quizzes.length > 0) {
                container.innerHTML = data.quizzes.map(quiz => {
                    const created = quiz.created_at ? new Date(quiz.created_at).toLocaleString() : '';
                    const active = quiz.active !== false;
                    const attempts = quiz.attempts || [];

                    const attemptList = attempts.length
                        ? attempts.map(att => `
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <span>${escapeHtml(att.username || 'Anonymous')}</span>
                                <div>
                                    <span class="badge bg-success me-2">${att.score}/${att.total_questions} (${att.percentage}%)</span>
                                    <button class="btn btn-outline-danger btn-sm py-0" onclick="removeAttempt('${quiz.code}', '${att.attempt_id}')">Remove</button>
                                </div>
                            </div>
                          `).join('')
                        : '<div class="text-muted py-2">No attempts yet.</div>';

                    return `
                        <div class="card mb-3 bg-light bg-opacity-10">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                                    <div>
                                        <span class="badge bg-dark fs-6 mb-2">${quiz.code}</span>
                                        <h5 class="card-title mb-0">${escapeHtml(quiz.title || 'Untitled Quiz')}</h5>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-light btn-sm" onclick="copyCode('${quiz.code}')">Copy Code</button>
                                        <button class="btn btn-${active ? 'warning' : 'success'} btn-sm" onclick="toggleQuizActive('${quiz.code}', ${active})">
                                            ${active ? 'Stop Quiz' : 'Activate Quiz'}
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-3 flex-wrap text-muted small mb-3">
                                    <span>Created: ${created}</span>
                                    <span>Questions: ${quiz.num_questions}</span>
                                    <span>Difficulty: ${(quiz.difficulty || 'custom').toUpperCase()}</span>
                                    <span>Attempts: ${quiz.attempts_count || 0}</span>
                                </div>
                                
                                <button class="btn btn-primary btn-sm mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#attempts-${quiz.code}">
                                    View Attempts
                                </button>
                                
                                <div class="collapse mt-2" id="attempts-${quiz.code}">
                                    <div class="card card-body bg-dark bg-opacity-25">
                                        ${attemptList}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <h4 class="text-muted">No custom quizzes yet</h4>
                        <p class="text-muted">Create a quiz code from the quiz builder to see it here.</p>
                    </div>`;
            }
            window.customQuizzesLoaded = true;
        } catch (error) {
            console.error('Error loading custom quizzes:', error);
            container.innerHTML = `<div class="text-center text-danger p-4">Error loading custom quizzes: ${escapeHtml(error.message)}</div>`;
        }
    }

    async function loadStatusBar() {
        try {
            const resp = await fetch('/api/aptitude/stats?t=' + new Date().getTime());
            const data = await resp.json();

            if (data.error) {
                document.getElementById('status-content').innerHTML = '<p class="text-white-50">Unable to load statistics.</p>';
                return;
            }

            const statusHtml = `
                <div class="row g-4 mb-4 text-center">
                    <div class="col-md-4">
                        <div class="bg-white bg-opacity-10 rounded p-3 h-100">
                            <div class="small opacity-75">Questions Practiced</div>
                            <div class="display-6 fw-bold">${data.total_questions_answered || 0}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-white bg-opacity-10 rounded p-3 h-100">
                            <div class="small opacity-75">Overall Accuracy</div>
                            <div class="display-6 fw-bold">${data.overall_average || 0}%</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-white bg-opacity-10 rounded p-3 h-100">
                            <div class="small opacity-75">Total Correct</div>
                            <div class="display-6 fw-bold">${data.total_correct || 0}</div>
                        </div>
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="p-3 rounded border-start border-4 border-success bg-white bg-opacity-10">
                            <div class="small opacity-75">Easy Accuracy</div>
                            <div class="h4 mb-1">${data.easy.average || 0}%</div>
                            <div class="small opacity-50">${data.easy.correct}/${data.easy.total} correct</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 rounded border-start border-4 border-warning bg-white bg-opacity-10">
                            <div class="small opacity-75">Medium Accuracy</div>
                            <div class="h4 mb-1">${data.medium.average || 0}%</div>
                            <div class="small opacity-50">${data.medium.correct}/${data.medium.total} correct</div>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <div class="p-3 rounded border-start border-4 border-primary bg-white bg-opacity-10">
                            <div class="small opacity-75">DSA Score</div>
                            <div class="h4 mb-1">${data.dsa_score || 0}</div>
                            <div class="small opacity-50">Points</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 rounded border-start border-4 border-info bg-white bg-opacity-10">
                            <div class="small opacity-75">DSA Solved</div>
                            <div class="h4 mb-1">${data.dsa_solved_count || 0}</div>
                            <div class="small opacity-50">Questions</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('status-content').innerHTML = statusHtml;
        } catch (error) {
            console.error('Error loading status:', error);
            document.getElementById('status-content').innerHTML = '<p class="text-white-50">Error loading statistics.</p>';
        }
    }

    function toggleChatDetails(id) {
        const details = document.getElementById('chat-details-' + id);
        const chevron = document.getElementById('chevron-' + id);
        if (!details) return;

        if (details.classList.contains('d-none')) {
            details.classList.remove('d-none');
            if (chevron) chevron.textContent = '‚ñ≤';
        } else {
            details.classList.add('d-none');
            if (chevron) chevron.textContent = '‚ñº';
        }
    }

    function copyCode(code) {
        navigator.clipboard.writeText(code);
        alert('Code copied to clipboard');
    }

    async function toggleQuizActive(code, currentlyActive) {
        try {
            const resp = await fetch(`/api/custom-quizzes/${code}/toggle-active`, { method: 'POST' });
            const data = await resp.json();
            if (!resp.ok || data.error) {
                alert(data.error || 'Unable to update quiz status');
                return;
            }
            window.customQuizzesLoaded = false;
            loadMyCustomQuizzes();
        } catch (error) {
            alert('Error updating quiz status: ' + error.message);
        }
    }

    async function deleteChat(evt, chatId) {
        evt.stopPropagation();
        if (!confirm('Delete this chat conversation?')) return;
        try {
            const resp = await fetch(`/api/user-chats/${chatId}`, { method: 'DELETE' });
            const data = await resp.json();
            if (!resp.ok || data.error) {
                alert(data.error || 'Unable to delete chat');
                return;
            }
            window.chatsLoaded = false;
            loadChats();
        } catch (error) {
            alert('Error deleting chat: ' + error.message);
        }
    }

    async function removeAttempt(code, attemptId) {
        if (!attemptId) return;
        if (!confirm('Remove this attempt so the student can re-attempt this quiz?')) return;
        try {
            const resp = await fetch(`/api/custom-quizzes/${code}/attempts/${attemptId}`, { method: 'DELETE' });
            const data = await resp.json();
            if (!resp.ok || data.error) {
                alert(data.error || 'Unable to remove attempt');
                return;
            }
            window.customQuizzesLoaded = false;
            loadMyCustomQuizzes();
        } catch (error) {
            alert('Error removing attempt: ' + error.message);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function deleteAccount() {
        if (!confirm('Are you absolutely sure you want to delete your account?\n\nThis will permanently delete ALL your data.\n\nThis action CANNOT be undone!')) return;

        const confirmation = prompt('Type "DELETE" (all caps) to confirm account deletion:');
        if (confirmation !== 'DELETE') {
            alert('Account deletion cancelled.');
            return;
        }

        try {
            const resp = await fetch('/delete-account', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await resp.json();

            if (!resp.ok || data.error) {
                alert('Error: ' + (data.error || 'Failed to delete account'));
                return;
            }

            alert('Your account has been deleted successfully.');
            window.location.href = '/login';
        } catch (error) {
            alert('Error deleting account: ' + error.message);
        }
    }
</script>
{% endblock %}